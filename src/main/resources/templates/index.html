<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Главная страница</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div th:if="${user != null}">
    <h1>Добро пожаловать, <span th:text="${user.firstName}">Пользователь</span>!</h1>
    <p>ID: <span th:text="${user.id}"></span></p>
    <p>Имя: <span th:text="${user.firstName}"></span></p>
    <p>Фамилия: <span th:text="${user.lastName}"></span></p>
    <p>Username: <span th:text="${user.username}"></span></p>
    <p>Фото: <img th:src="${user.photoUrl}" alt="Фото пользователя"></p>
    <p>Дата аутентификации: <span th:text="${user.authDate}"></span></p>
</div>

<div th:if="${user == null}">
    <h1>Идет аутентификация через Telegram...</h1>
    <script>
        const initData = Telegram.WebApp.initData;
        if (initData) {
            const params = new URLSearchParams(initData);
            const data = {};
            for (const [key, value] of params.entries()) {
                data[key] = value;
            }
            // Отправляем POST-запрос для аутентификации
            fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) return response.json();
                    else throw new Error("Неверная аутентификация");
                })
                .then(result => {
                    if (result.redirect) {
                        window.location.href = result.redirect;
                    }
                })
                .catch(e => {
                    console.error("Ошибка аутентификации", e);
                    document.body.innerHTML = "<p>Ошибка аутентификации. Попробуйте еще раз.</p>";
                });
        } else {
            document.body.innerHTML = "<p>Данные аутентификации не найдены. Запустите приложение через Telegram.</p>";
        }
    </script>
</div>
</body>
</html>
